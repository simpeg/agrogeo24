# Run notebooks to test they run without errors
name: test

# Only run on PRs and the main branch. Pushes to branches will only tested
# when a PR is opened.
on:
  pull_request:
  push:
    branches:
      - main


# Use bash by default in all jobs
defaults:
  run:
    shell: bash

jobs:
  #############################################################################
  # Run tests and upload to codecov
  test:
    name: Test notebooks
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: simpeg-agrogeo24
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@85880fa0301c86cca9da44039ee3bb12d3bedbfa
        with:
          access_token: ${{ github.token }}

      - name: Checkout
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: ${{ env.ENVIRONMENT }}
          environment-file: environment.yml
          auto-actiate-base: false
          miniforge-version: latest

      - name: Init Mamba
        run: mamba init

      - name: Install nbconvert
        run: |
          mamba activate $ENVIRONMENT
          mamba install nbconvert

      - name: List installed packages
        run: |
          mamba activate $ENVIRONMENT
          mamba info
          mamba list

      - name: Run notebooks
        run: |
          mamba activate $ENVIRONMENT
          jupyter-nbconvert --execute --to notebook --inplace --ExecutePreprocessor.kernel_name=python3 notebooks/*.ipynb
